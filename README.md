# iMARGI Data Processing Methods

In this repository, we introduce the data processing methods (tools and usages) of iMARGI, from fastq to RNA-DNA interaction map.

- [iMARGI Data Processing Methods](#imargi-data-processing-methods)
    - [1. Tools and data dependencies](#1-tools-and-data-dependencies)
        - [1.1. Required tools](#11-required-tools)
        - [1.2. Reference data](#12-reference-data)
    - [2. Data processing](#2-data-processing)
        - [2.1. Input data and directory](#21-input-data-and-directory)
        - [2.2. Fastq file cleaning](#22-fastq-file-cleaning)
        - [2.3. Mapping](#23-mapping)
        - [2.4. Pair parsing and filtering](#24-pair-parsing-and-filtering)
        - [2.5. Multiple output formats](#25-multiple-output-formats)
    - [3. Further analysis tips](#3-further-analysis-tips)
        - [3.1. Gene annotation using BEDOPS](#31-gene-annotation-using-bedops)
        - [3.2. Analyze in R](#32-analyze-in-r)
    - [2.2. Tools](#22-tools)
    - [3.1. CT filtering](#31-ct-filtering)
    - [3.2. Mapping](#32-mapping)
    - [3.3. Pair parse and filter](#33-pair-parse-and-filter)

## 1. Tools and data dependencies

To incorporate with standard pipelines of 4D Nucleome project (4DN), we use the same tools and reference data adopted
by 4DN DCIC (4D Nucleome Data Coordination and Integration Center) to process iMARGI data.

### 1.1. Required tools

Make sure that all the required tools are installed on your linux system with correct exec path configurations.

- [bwa](https://github.com/lh3/bwa) (version 0.7.17)
- [pairtools](https://github.com/mirnylab/pairtools) (version 0.2.0)
- [samtools](http://www.htslib.org/download/) (version 1.9)
- [seqtk]
- [pbgzip]
- [GNU parallel](https://www.gnu.org/software/parallel/)
- [ct_clean_pefastq.sh](./ct_clean_pefastq.sh): provided in this repository. Put it in your exec path and `chmod +x`,
   or specify directory when you use it.
- [pairs_to_bedpe.sh](): provided in this repository. Put it in your exec path and `chmod +x`, or specify directory
   when you use it.
- [GNU awk](https://www.gnu.org/software/gawk/manual/html_node/Quick-Installation.html): most of Linux distributions
  have GNU awk default installed.
- `bash`, `sort`, `gunzip`, `zcat`: Almost all of Linux distributions have these tools default installed.

### 1.2. Reference data

The reference genome and gene annotation GTF file used in 4DN are the same as ENCODE project. They can be downloaded
from [ENCODE project website](https://www.encodeproject.org/data-standards/reference-sequences/).

- Reference Genome: GRCh38_no_alt_analysis_set_GCA_000001405.15. [download link](https://www.encodeproject.org/files/GRCh38_no_alt_analysis_set_GCA_000001405.15/@@download/GRCh38_no_alt_analysis_set_GCA_000001405.15.fasta.gz)
- Gene Annotations:  GRCh38 GENCODE V24 Primary (GTF format). [download link](https://www.encodeproject.org/files/ENCFF824ZKD/@@download/ENCFF824ZKD.gtf.gz)

## 2. Data processing

As the iMARGI data we generated are big high-throughput sequencing data (hundreds of millions read pairs), so a high
performance computing machine with Linux system is necessary, such as 8 CPU cores with 32 GB memory. Almost all of the
tools used here support parallel computing.

### 2.1. Input data and directory

The raw data generated by iMARGI experimental technique are paired-end sequencing read pairs in FASTQ format. That's
the only input data we needed. Besides, we also need reference genome and gene annotation file.
Here, we assume the input files and directory like this:

``` bash
|-- |
    |-- ref
    |   |-- GRCh38_no_alt_analysis_set_GCA_000001405.15.fasta
    |   |-- gencode.v24.primary_assembly.annotation.gtf
    |
    |-- raw_data
    |   |-- HEK_iMARGI_R1.fastq.gz
    |   |-- HEK_iMARGI_R2.fastq.gz
    |   
    |-- clean_fastq
    |   |--
    |
    |-- mapping_output
    |   |--
    |
    |-- pair_output
        |--
```

### 2.2. Fastq file cleaning

According to the design of iMARGI sequencing library construction, we need to clean the fastq files before mapping.
The first 2 bases (5' end) of RNA end (Read 1) are random nucleotides, which need to be removed before mapping.
The first 2 bases (5' end) of DNA end (Read 2) must be "CT" for correct ligation of RNA and DNA fragments. So we will
filter our the read pairs without "CT" as the first two bases of DNA end (Read 2).

We use the bash script `ct_clean_pefastq.sh` to clean the paired fastq files. We can use one command line to do that.
The `-t` and `-b` parameters are used for parallel computing, which means use 16 CPU cores and read in 4 million read
pairs each time in each CPU core. You need to adjust the parameters based on you machine configurations.

``` bash
bash ct_clean_pair.sh \
    -1 ./raw_data/HEK_iMARGI_R1.fastq.gz \
    -2 ./raw_data/HEK_iMARGI_R2.fastq.gz \
    -d true
    -o ./clean_fastq/ \
    -t 16 -b 4000000
```

Here is the usages of the and help info of the `ct_clean_pefastq.sh` script.

Usage: ct_clean_pair.sh [-1 <fastq.gz_R1>] [-2 <fastq.gz_R2>] [-o <output_dir>] [-d <drop>]
                [-t <threads>] [-b <block_size>]

    Dependency: seqtk, zcat, awk, parallel

    This script will clean the DNA end reads (R2) of iMARGI sequencing Fastq data. According to the iMARGI design,
    DNA end reads (R2) must start with "CT". So it cleans the data by filtering out those R2 reads not starting with "CT".
    After filtering R2, it fixes the paired reads in R1. If "-d" was set as "true", it will drop all the non "CT" started R2
    reads and paired R1 reads, which outputs two fastq files with prefix "clean_". If "-d" was "false", the filtered read
    pairs would also be outputed in a pair of fastq files with prefix "drop_". The default setting of "-d" is "false".
    The input fastq files must be gzip files, i.e., fastq.gz or fq.gz. The output files are also fastq.gz.

    -1 : R1 fastq.gz file, if there are multiple files, just separated with space, such as -1 l1_R1.fq l2_R1.fq
    -2 : R2 fastq.gz file, if there are multiple files, just separated with space, such as -1 l1_R2.fq l2_R2.fq
    -o : output directoy
    -d : Flag of dropping. Default is false. Option "true".
    -t : CPU threads for parallelized processing based on GNU parallel, Default 2
    -b : Fastq data block size (number of reads) for each thread. Default 2000000.
    -h : show usage help






### 2.3. Mapping


### 2.4. Pair parsing and filtering

### 2.5. Multiple output formats

## 3. Further analysis tips

### 3.1. Gene annotation using BEDOPS

### 3.2. Analyze in R





## 2.2. Tools

- CT filtering: ct_clean_pair.sh => fastq.gz
- Mapping: bwa mem => bam
- Pair parse: pairtools and pairix => `bedpe` and `bedpe.gz`(pairix indexed)
- Gene (RNA end) annotation: BEDOPS bedmap => `bedpe` and `bedpe.gz`
- Generate RNA-DNA interaction matrix: cooler => `.cool`
- Generate GIVE interaction format => GIVE-Toolbox => `.giveX`
- Visualization: higlass and GIVE
- Distributed pipeline: Docker and nextflow

## 3.1. CT filtering

According to the iMARGI design, the correct first 2 bases in the DNA end must be "CT". So we can remove those read pairs not started with "CT" in DNA end. We created a bash script tool `ct_clean_pair.sh` to do CT filtering. 
- Dependencies: seqtk, zcat, awk, parallel
- Input: `fastq.gz` files of R1 and R2
- Output: The clean `fastq.gz` files and the drop `fastq.gz` files. The first 2 bases of DNA end (R2) were removed in both clean and drop `fastq.gz` files.
- Parallelization: Support `-t`
``` bash
bash ct_clean_pair.sh -1 fastq/HEK293library5_WW_S1_L007_R1_001.fastq.gz -2 fastq/HEK293library5_WW_S1_L007_R2_001.fastq.gz -o ./output/ -t 16 -b 4000000 
```
## 3.2. Mapping
Following the standard 4DN HiC pipeline, use bwa with -SP5M parameters.
- Dependencies: bwa, samtools
- Input: `fastq.gz` files of R1 and R2
- Output: `.bam` files
-Parallelization: Support `-t`
```
bwa index -p ref/bwa_index/bwa_index_GRCh38 GRCh38_no_alt_analysis_set_GCA_000001405.15.fa
nohup bash -c "bwa mem -t 16 -SP5M ref/bwa_index/bwa_index_GRCh38 output/clean_HEK293library5_WW_S1_L007_R1_001.fastq.gz output/clean_HEK293library5_WW_S1_L007_R2_001.fastq.gz | samtools view -Shb -@ 16 - >output/clean_HEK.bam" >log/bwa_clean_HEK.log & 
```
## 3.3. Pair parse and filter
Use pairtools to do pair parsing, which includes several sub-processes, `parse`, `sort`, `dedup`, `split`, `select` and `pairix`